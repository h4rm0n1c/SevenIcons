name: Validate icon theme (no symlinks, real PNGs)

on:
  push:
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install gtk tools
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-bin libgdk-pixbuf2.0-bin librsvg2-bin

      - name: Locate theme directory
        id: theme
        run: |
          set -euo pipefail
          # Find the first index.theme in the repo (should be the theme root)
          THEME_DIR="$(dirname "$(find . -type f -name index.theme -print -quit)")"
          test -n "$THEME_DIR"
          echo "THEME_DIR=$THEME_DIR"
          echo "theme_dir=$THEME_DIR" >> "$GITHUB_OUTPUT"
          test -f "$THEME_DIR/index.theme"

      - name: Fail if any symlinks exist
        run: |
          set -euo pipefail
          THEME_DIR="${{ steps.theme.outputs.theme_dir }}"
          test "$(find "$THEME_DIR" -type l | wc -l)" -eq 0

      - name: Fail if any paths contain whitespace
        run: |
          set -euo pipefail
          THEME_DIR="${{ steps.theme.outputs.theme_dir }}"
          python3 - <<'PY'
          import os, sys
          root = os.environ["THEME_DIR"]
          bad = []
          for dirpath, dirnames, filenames in os.walk(root):
              for name in list(dirnames) + list(filenames):
                  p = os.path.join(dirpath, name)
                  if any(ch.isspace() for ch in p):
                      bad.append(p)
          if bad:
              print("Whitespace in paths (rename these):")
              for p in bad:
                  print(" ", p)
              sys.exit(1)
          PY
        env:
          THEME_DIR: ${{ steps.theme.outputs.theme_dir }}

      - name: Fail if any .png is not a real PNG (magic header)
        run: |
          set -euo pipefail
          THEME_DIR="${{ steps.theme.outputs.theme_dir }}"
          python3 - <<'PY'
          import os, sys
          root = os.environ["THEME_DIR"]
          bad = 0
          for dirpath, _, files in os.walk(root):
              for fn in files:
                  if fn.lower().endswith(".png"):
                      p = os.path.join(dirpath, fn)
                      with open(p, "rb") as f:
                          sig = f.read(8)
                      if sig != b"\x89PNG\r\n\x1a\n":
                          print("NOT_PNG:", p)
                          bad = 1
          sys.exit(bad)
          PY
        env:
          THEME_DIR: ${{ steps.theme.outputs.theme_dir }}

      - name: Ensure gtk icon cache can be built
        run: |
          set -euo pipefail
          THEME_DIR="${{ steps.theme.outputs.theme_dir }}"
          rm -f "$THEME_DIR/.icon-theme.cache" "$THEME_DIR/icon-theme.cache" || true
          gtk-update-icon-cache -f -v "$THEME_DIR"
          ls -la "$THEME_DIR" | grep -E 'icon-theme\.cache|\.icon-theme\.cache' || true
