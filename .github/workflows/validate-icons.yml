name: Validate icon theme (no symlinks, real PNGs)

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    container: ubuntu:22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install gtk tools
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          set -euo pipefail
          if command -v sudo >/dev/null 2>&1; then
            SUDO=sudo
          else
            SUDO=""
          fi
          $SUDO apt-get update
          $SUDO apt-get install -y --no-install-recommends libgtk-3-bin libgdk-pixbuf2.0-bin librsvg2-bin
          # Some Ubuntu containers do not refresh pixbuf loader caches automatically
          # which can cause gtk-update-icon-cache to fail to parse SVGs.
          $SUDO gdk-pixbuf-query-loaders --update-cache || gdk-pixbuf-query-loaders --update-cache

      - name: Sanity: theme dir + index.theme present
        run: |
          set -euo pipefail
          test -d SevenIcons
          test -f SevenIcons/index.theme

      - name: Fail if any symlinks exist
        run: |
          set -euo pipefail
          test "$(find SevenIcons -type l | wc -l)" -eq 0

      - name: Fail if any paths contain whitespace or non-UTF8 bytes
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import os, sys

          root = "SevenIcons"
          bad_ws = []
          bad_utf8 = []

          def has_surrogates(s: str) -> bool:
              return any(0xDC80 <= ord(ch) <= 0xDCFF for ch in s)

          for dirpath, dirnames, filenames in os.walk(root):
              for name in list(dirnames) + list(filenames):
                  p = os.path.join(dirpath, name)
                  if any(ch.isspace() for ch in p):
                      bad_ws.append(p)
                  if has_surrogates(p):
                      bad_utf8.append(p)

          if bad_ws:
              print("Whitespace in paths (rename these):")
              for p in bad_ws[:200]:
                  print("  ", p)

          if bad_utf8:
              print("Non-UTF8 paths detected (rename these):")
              for p in bad_utf8[:200]:
                  print("  ", p)

          sys.exit(1 if (bad_ws or bad_utf8) else 0)
          PY

      - name: Fail if any .png is not a real PNG (magic header)
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import os, sys

          bad = 0
          for root, _, files in os.walk("SevenIcons"):
              for fn in files:
                  if fn.lower().endswith(".png"):
                      p = os.path.join(root, fn)
                      with open(p, "rb") as f:
                          sig = f.read(8)
                      if sig != b"\x89PNG\r\n\x1a\n":
                          print("NOT_PNG:", p)
                          bad = 1
          sys.exit(bad)
          PY

      - name: Build GTK icon cache
        run: |
          set -euo pipefail
          rm -f SevenIcons/icon-theme.cache SevenIcons/.icon-theme.cache || true
          gtk-update-icon-cache -f -v SevenIcons

      - name: Validate GTK icon cache artifact exists
        run: |
          set -euo pipefail
          ls -la SevenIcons | grep -E 'icon-theme\.cache|\.icon-theme\.cache'
