name: Validate icon theme (no symlinks, real PNGs)

on:
  push:
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install gtk + pixbuf + SVG loader
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-bin libgdk-pixbuf2.0-bin librsvg2-common

          # Find gdk-pixbuf-query-loaders (name/path varies)
          if command -v gdk-pixbuf-query-loaders >/dev/null 2>&1; then
            QL="$(command -v gdk-pixbuf-query-loaders)"
          else
            QL="$(ls -1 /usr/lib/*/gdk-pixbuf-2.0/*/query-loaders 2>/dev/null | head -n 1 || true)"
          fi

          echo "QUERY_LOADERS=${QL:-<not found>}"

          # Update the loader cache if we found the tool
          if [ -n "${QL:-}" ] && [ -x "$QL" ]; then
            sudo "$QL" --update-cache || true
          fi

      - name: Fail if any symlinks exist
        run: |
          test "$(find SevenIcons -type l | wc -l)" -eq 0

      - name: Fail if any .png is not a real PNG (magic header)
        run: |
          python3 - <<'PY'
          import os, sys
          bad = 0
          for root, _, files in os.walk("SevenIcons"):
            for fn in files:
              if fn.lower().endswith(".png"):
                p = os.path.join(root, fn)
                with open(p, "rb") as f:
                  sig = f.read(8)
                if sig != b"\x89PNG\r\n\x1a\n":
                  print("NOT_PNG:", p)
                  bad = 1
          sys.exit(bad)
          PY

      - name: Ensure gtk icon cache can be built
        run: |
          rm -f SevenIcons/.icon-theme.cache SevenIcons/icon-theme.cache || true
          gtk-update-icon-cache -f SevenIcons
